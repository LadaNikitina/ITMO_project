# Подготовка датасета для pre-train диалоговых эмбеддеров

Эта директория предоставляет функционал для предобработки различных диалоговых датасетов, генерируя на их основе диалоговый корпус для контрастивного (до)обучения диалоговых эмбеддеров.

## Поддерживаемые датасеты

На данный момент поддержка осуществляется для следующих датасетов:
  - MultiWOZ
  - CamRest676
  - WOZ
  - Schema-Guided Dialogue
  - Frames
  - MSR-E2E
  - Taskmaster
  - MetalWOZ
  - SMD (Stanford Multi-Domain Dialogue)

## Формирование объединенного корпуса диалогов - pretrain_collecting.py

1. **Предобработка**: Каждый датасет обрабатывается с использованием функции, соответствующей его названию, например, `prepare_multiwoz_data`. Настраиваемые параметры:
   - `max_line`: Максимальное количество строк для обработки (по умолчанию – все строки).
   - `data_path`: Путь к папке с сырыми данными датасета.
   - `only_last_turn`: Добавлять в данные только последнюю реплику диалога или каждую реплику из диалога.

2. **Структура данных**:
   - Для holdout-датасетов: данные разделяются на `train`, `dev` и `test`.
   - Для остальных датасетов: все данные объединяются в единый тренировочный набор `train`.

3. **Вывод**:
   - Обработанные данные сохраняются в файл `pre_train.pkl` в формате pickle.
   

## Инструкция по запуску

1. Поместите сырые данные датасетов в папку `dialog_datasets`.
2. Запустите скрипт предобработки:
   ```bash
   python preprocessing.py
   
## Аналитика датасетов - dataset_analytics.py

Функция dataset_analysis выполняет анализ диалогового датасета и сохраняет результаты в текстовый файл. Анализ включает:

Ключевые метрики:
- Число диалогов в датасете.
- Число реплик диалогов в датасете.
- Средняя длина реплик (в символах).
- Средняя длина диалога (в символах).
- Среднее число реплик в диалоге.
- Анализ частоты слов: определение самых часто встречающихся слов в диалогах (исключая короткие слова менее 4 символов).

Аналитика записывается в файл. Данная функция вызывается для каждого датасета в модуле {название_датасета}\_preprocessing.py
   
## Очистка и предобработка датасета MultiWOZ

Этот модуль обеспечивает предобработку диалогового датасета MultiWOZ (версия 2.1) для создания данных, готовых к использованию в задачах обработки естественного языка. Основные этапы включают извлечение, очистку и структурирование данных на уровне реплик диалога.

Перед запуском убедитесь, что файлы датасета MultiWOZ находятся в папке f"{data_path}/MultiWOZ-2.1/ и имеют имена train_dials.json, dev_dials.json и test_dials.json.

Каждый диалог состоит из последовательности реплик (взаимодействий системы/менеджера и пользователя). Из каждого хода (turn на английском) диалога извлекаются:

- Ответ системы: Поле "system_transcript", содержащее текст ответа системы.
- Реплика пользователя: Поле "transcript", содержащее текст пользовательского запроса.

Лишние пробелы в репликах удаляются с помощью метода .strip(). Если текст отсутствует (например, в разметке пропущен один из полей), используются пустые строки по умолчанию. История диалога строится динамически: каждый новый ответ системы и реплика пользователя добавляются к текущей последовательности. Это позволяет на каждом этапе диалога иметь полный контекст взаимодействия, который может быть критически важен для моделей, обучающихся на данных с учетом контекста.

Каждый экземпляр данных, подготовленный в ходе предобработки, имеет следующую структуру:
```
{
  "ID": "<ID диалога>",
  "turn_id": "<Номер хода>",
  "turn_usr": "<Запрос пользователя>",
  "turn_sys": "<Ответ системы>",
  "dialog_history": ["<История диалога до текущего хода диалога (dialog turn)>"]
}
```

Формат данных в этом и последующих датасетах будет идентичен приведенной выше структуре.

## Очистка и предобработка датасета CamRest676

Этот модуль обеспечивает предобработку диалогового датасета CamRest676 для создания данных, готовых к использованию в задачах обработки естественного языка.

Перед запуском убедитесь, что файл датасета CamRest676.json находится в папке f"{data_path}/CamRest676/".

Каждый диалог состоит из последовательности реплик (взаимодействий системы и пользователя). Из каждого хода диалога извлекаются:

- Запрос пользователя: Поле "usr.transcript", содержащее текст пользовательского запроса.
- Ответ системы: Поле "sys.sent", содержащее текст ответа системы.

## Очистка и предобработка датасета WOZ

Этот модуль обеспечивает предобработку диалогового датасета WOZ для создания данных, готовых к использованию в задачах обработки естественного языка.

Перед запуском убедитесь, что файлы датасета WOZ находятся в папке f"{data_path}/neural-belief-tracker/data/woz/" и имеют имена woz_train_en.json, woz_validate_en.json, и woz_test_en.json.

Каждый диалог состоит из последовательности реплик (взаимодействий системы и пользователя). Из каждого хода диалога извлекаются:

- Запрос пользователя: Поле "transcript", содержащее текст пользовательского запроса.
- Ответ системы: Поле "system_transcript", содержащее текст ответа системы.

## Очистка и предобработка датасета Schema

Этот модуль обеспечивает предобработку диалогового датасета Schema-Guided Dialogue (DSTC8) для создания данных, готовых к использованию в задачах обработки естественного языка.

Перед запуском убедитесь, что файлы датасета Schema находятся в папках f"{data_path}/dstc8-schema-guided-dialogue/train/", f"{data_path}/dstc8-schema-guided-dialogue/dev/" и f"{data_path}/dstc8-schema-guided-dialogue/test/". Все файлы, содержащие диалоги, должны иметь название с подстрокой "dialogues".

Каждый диалог состоит из последовательности реплик (взаимодействий системы и пользователя). Из каждого хода диалога извлекаются:

- Запрос пользователя: Поле "utterance", если "speaker" равно "USER".
- Ответ системы: Поле "utterance", если "speaker" равно "SYSTEM". 

## Очистка и предобработка датасета Frames

Этот модуль обеспечивает предобработку диалогового датасета FRAMES для создания данных, готовых к использованию в задачах обработки естественного языка.

Перед запуском убедитесь, что файл датасета FRAMES находится в папке f"{data_path}/" и имеет имя frames.json.

Каждый диалог состоит из последовательности реплик (взаимодействий системы и пользователя). Из каждого хода диалога извлекаются:

- Запрос пользователя: Поле "text", если "author" равно "user".
- Ответ системы: Поле "text", если "author" равно "wizard". 

## Очистка и предобработка датасета MSR-E2E

Этот модуль обеспечивает предобработку диалогового датасета MSR-E2E для создания данных, готовых к использованию в задачах обработки естественного языка.

Перед запуском убедитесь, что файлы датасета MSR-E2E находятся в папке f"{data_path}/e2e_dialog_challenge/data/" и имеют имена movie_all.tsv, restaurant_all.tsv и taxi_all.tsv.

Каждый диалог состоит из последовательности реплик (взаимодействий системы и пользователя). Из каждого хода диалога извлекаются:

- Запрос пользователя: Поле "message", если поле "sender" равно "user".
- Ответ системы: Поле "message", если поле "sender" равно "agent".

## Очистка и предобработка датасета Taskmaster

Этот модуль обеспечивает предобработку диалогового датасета TaskMaster для создания данных, готовых к использованию в задачах обработки естественного языка.

Перед запуском убедитесь, что файлы датасета TaskMaster находятся в папке f"{data_path}/Taskmaster/TM-1-2019/" и включают файлы woz-dialogs.json, self-dialogs.json, а также файлы с идентификаторами train.csv и dev.csv.

Каждый диалог состоит из последовательности реплик (взаимодействий системы и пользователя). Из каждого хода диалога извлекаются:

- Запрос пользователя: Поле "text", если "speaker" равно "USER".
- Ответ системы: Поле "text", если "speaker" равно "ASSISTANT".

## Очистка и предобработка датасета MetalWOZ

Этот модуль обеспечивает предобработку диалогового датасета MetalWOZ для создания данных, готовых к использованию в задачах обработки естественного языка.

Перед запуском убедитесь, что файлы датасета MetalWOZ находятся в папке f"{data_path}/metalwoz/dialogues/" и имеют формат .txt, где каждая строка представляет отдельный диалог в формате JSON.

Каждый диалог состоит из последовательности реплик (взаимодействий системы и пользователя). Из каждого хода диалога извлекаются:

- Запрос пользователя: Текст из нечетных индексов "turns".
- Ответ системы: Текст из четных индексов "turns".

## Очистка и предобработка датасета SMD

Этот модуль обеспечивает предобработку диалогового датасета SMD (Stanford Multi-Domain Dialogue) для создания данных, готовых к использованию в задачах обработки естественного языка.

Перед запуском убедитесь, что файлы датасета SMD находятся в папке f"{data_path}/kvret/" и имеют имена kvret_train_public.json, kvret_dev_public.json, и kvret_test_public.json.

Каждый диалог состоит из последовательности реплик (взаимодействий системы и пользователя). Из каждого хода диалога извлекаются:

- Запрос пользователя: Поле "data.utterance", если "turn" равно "driver".
- Ответ системы: Поле "data.utterance", если "turn" равно "assistant".
   
## Генерация пар диалогов из предобработанного датасета

Этот скрипт создает пары последовательных реплик диалога из предобработанного датасета и сохраняет их в CSV-файл. Каждая пара состоит из двух реплик: первая и вторая последовательные реплики, прошедшие фильтрацию по минимальной длине.

### Как работает скрипт

Загрузка данных: исходные данные загружаются из файла в формате pickle (pre_train.pkl).

Формирование пар диалогов:
- Реплики из истории диалога (dialog_history) очищаются от символов перевода строки и табуляции.
- Последовательные реплики проверяются на соответствие минимальной длине (по количеству слов). Если обе реплики длиннее заданного порога, они добавляются в список пар.

Все сгенерированные пары реплик перемешиваются случайным образом.

### Использование

Поместите файл pre_train.pkl в ту же директорию, что и скрипт.

Запустите скрипт:
```
python generate_dialog_pairs.py\
```

Пары диалогов будут сохранены в файл output.csv.

Параметры

- input_file: путь к входному файлу с данными в формате pickle.
- output_file: путь к выходному файлу в формате CSV.
- min_length: минимальное количество слов для каждой реплики.
